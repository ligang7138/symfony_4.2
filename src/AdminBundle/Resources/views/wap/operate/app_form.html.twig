<style>
    #pr_photo_file,#pr_photo_file_del{
        position: relative;
        display: inline-block;
        background: #D0EEFF;
        border: 1px solid #99D3F5;
        border-radius: 4px;
        padding: 4px 12px;
        overflow: hidden;
        color: #1E88C7;
        text-decoration: none;
        text-indent: 0;
        line-height: 20px;
    }
    #pr_photo_file #pr_photo {
        position: absolute;
        font-size: 100px;
        right: 0;
        top: 0;
        opacity: 0;
    }
    #pr_photo_file_del #del_photo {
        position: absolute;
        font-size: 100px;
        right: 0;
        top: 0;
        opacity: 0;
    }
    #pr_photo_file:hover,#pr_photo_file_del:hover {
        background: #AADFFD;
        border-color: #78C3F3;
        color: #004974;
        text-decoration: none;
    }
</style>
<div class="page-container">
    <div class="page animation-fade page-forms">
        <div class="page-content container-fluid">

            <div class="row">
                <div class="col-md-12">

                    <div class="panel">
                        <div class="panel-heading">
                            <h3 class="panel-title">app发版添加或修改</h3>
                        </div>
                        <div class="panel-body">
                            <form name="apk_upload_form" id="pr_photo_form" method="post">
                                <input type="hidden"  name="content" id="pr_photo_">
                                <input type="hidden" id="ext" name="ext" value="">
                                <input type="hidden" name="namespace" value="download">
                            </form>
                            <form class="form-horizontal fv-form fv-form-bootstrap" action="{{ path('admin_operate_appform', {'id': id}) }}" enctype="multipart/form-data" method="post" name="constraintsForm" id="constraintsForm">
                                <div class="form-group has-feedback">
                                    <label class="col-sm-3 control-label">标题：</label>
                                    <div class="col-md-4 form-bolck col-sm-8">
                                        <input name="title"  type="text" class="form-control" required=""  aria-required="true" placeholder="标题" value="{{ app.title }}">
                                    </div>
                                </div>
                                <div class="form-group has-feedback">
                                    <label class="col-sm-3 control-label">是否强制更新：</label>
                                    <div class="col-md-4 form-bolck col-sm-8">
                                        <fieldset>
                                            <div class="row row-lg">
                                                <div class="col-sm-12 col-md-6">
                                                    <div class="radio-custom radio-primary">
                                                        <input id="inlineRadio1" value="0" name="is_force" {% if app.isForce == 0 %} checked {% endif %} type="radio">
                                                        <label for="inlineRadio1">不强制</label>
                                                    </div>
                                                </div>
                                                <div class="col-sm-12 col-md-6">
                                                    <div class="radio-custom radio-primary">
                                                        <input id="inlineRadio2" value="1" name="is_force" {% if app.isForce == 1 %} checked {% endif %} type="radio">
                                                        <label for="inlineRadio2">强制</label>
                                                    </div>
                                                </div>

                                            </div>
                                        </fieldset>
                                    </div>
                                </div>
                                <div class="form-group has-feedback">
                                    <label class="col-sm-3 control-label">说明：</label>
                                    <div class="col-md-4 form-bolck col-sm-8">
                                        <textarea name="info"  type="text" class="form-control" required=""  aria-required="true" placeholder="">{{ app.info }}</textarea>
                                    </div>
                                </div>
                                <div class="form-group has-feedback">
                                    <label class="col-sm-3 control-label">版本号：</label>
                                    <div class="col-md-4 form-bolck col-sm-8">
                                        <input name="version_no"  type="text" class="form-control" required=""  aria-required="true" placeholder="例如：2.0.3" value="{{ app.versionNo }}">
                                    </div>
                                </div>
                                <div class="form-group has-feedback">
                                    <label class="col-sm-3 control-label">大小：</label>
                                    <div class="col-md-4 form-bolck col-sm-8">
                                        <input type="text" class="form-control" required=""  aria-required="true" placeholder="" value="{{ app.filesize }}">
                                    </div>
                                </div>
                                <input type="hidden" id="filesize" name="filesize" value="{{ app.filesize }}">
                                <div class="form-group has-feedback">
                                    <label class="col-sm-3 control-label">系统类型：</label>
                                    <div class="col-md-4 form-bolck col-sm-8">
                                        <fieldset>
                                            <div class="row row-lg">
                                                <div class="col-sm-12 col-md-6">
                                                    <div class="radio-custom radio-primary">
                                                        <input id="inlineRadio1" value="1" name="type" {% if app.type == 1 %} checked {% endif %} type="radio">
                                                        <label for="inlineRadio1">android</label>
                                                    </div>
                                                </div>
                                                <div class="col-sm-12 col-md-6">
                                                    <div class="radio-custom radio-primary">
                                                        <input id="inlineRadio2" value="2" name="type" {% if app.type == 2 %} checked {% endif %} type="radio">
                                                        <label for="inlineRadio2">ios</label>
                                                    </div>
                                                </div>

                                            </div>
                                        </fieldset>
                                    </div>
                                </div>
                                <div class="form-group has-feedback">
                                    <label class="col-sm-3 control-label">app类型：</label>
                                    <div class="col-md-4 form-bolck col-sm-8">
                                        <fieldset>
                                            <div class="row row-lg">
                                                <div class="col-sm-12 col-md-6">
                                                    <div class="radio-custom radio-primary">
                                                        <input id="inlineRadio1" value="1" name="app_type" {% if app.appType == 1 %} checked {% endif %} type="radio">
                                                        <label for="inlineRadio1">沃投农</label>
                                                    </div>
                                                </div>
                                                <div class="col-sm-12 col-md-6">
                                                    <div class="radio-custom radio-primary">
                                                        <input id="inlineRadio2" value="2" name="app_type" {% if app.appType == 2 %} checked {% endif %} type="radio">
                                                        <label for="inlineRadio2">青松云商</label>
                                                    </div>
                                                </div>

                                            </div>
                                        </fieldset>
                                    </div>
                                </div>
                                <div class="form-group has-feedback">
                                    <label class="col-sm-3 control-label">app文件包：</label>
                                    <div class="form-bolck" style="display: inline-block;float: left;">
                                        <a href="javascript:;" id="pr_photo_file">
                                            <input type="file" accept="" name="file_" id="pr_photo" onchange="apk_upload(event,$(this));">
                                            <input type="hidden" name="app_url" id="app_url" value="{{ app.appUrl }}">
                                            上传
                                        </a>
                                    </div>
                                    <div class="col-sm-5 form-bolck control-text" id="apk_name"></div>
                                </div>
                                <div class="col-sm-4 col-sm-offset-3" style="margin-top: 20px;">
                                    <button type="button" class="btn btn-primary" id="validateButton">提交</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<script type="text/javascript">data_str='{{ "now"|date("Y-m-d") }}';</script>
<script>
    $('#validateButton').click(function () {
        fsubmit($("#constraintsForm"),function(data){
            alert(data.msg)
            if(data.code == 200) {
                close_tab();
                window.location.href = data.openUrl;
            }
        });
    })
    function apk_upload(e,v) {
        if(!stopFresh()){
            return false;
        }
        if(!/.+\.(apk)/.test($("#pr_photo").val())){
            alert('文件格式不正确，请选择正确的文件包!');
        }else{
            var that = v;

            var reader = new FileReader();
            var file = e.target.files[0];
            var file_base64 = '';
            reader.readAsDataURL(file);
            reader.onload=function(file){
                file_base64 = file.target.result;
                $('#pr_photo_').val(file_base64);
                $("#ext").val("apk");
            }

            setTimeout(function () {
            // 异步上传文件
            $('form[name="apk_upload_form"]').ajaxSubmit({
                url: "{{ admin_bundle.charUpload }}",
                type: 'POST',
                beforeSubmit: function (a, b, c) {
                    backOff(true);
                },
                headers:{'Authorization':hex_md5(data_str)},
                success:function(data){
                    var data_url = data.result.url;
                    var data_name = data_url.split('/');
                    msg(data.msg);
                    if(2000 == data.status){
                        $("#app_url").val('{{ admin_bundle.fileHost }}'+data.result.url);
                        $("#filesize").val(GetFileSize(v));
                        $('#apk_name').html(data_name[data_name.length-1]);
                        msg('上传成功',null,1);
                    }
                    backOff(false);
                    return false;
                },
                error : function(result) {
                    console.log(result);
                    msg('上传失败!');
                    backOff(false);
                    return false;
                },
                resetForm: false,
                dataType: 'json'
            });},350);
            return false;
        }
    }
    //获取文件大小
    function GetFileSize(obj) {
        try {
            var fileSize = 0;
            //for IE
            if ($.support.msie) {
                //before making an object of ActiveXObject,
                //please make sure ActiveX is enabled in your IE browser
                var objFSO = new ActiveXObject("Scripting.FileSystemObject");
                var filePath = obj[0].value;
                var objFile = objFSO.getFile(filePath);
                var fileSize = objFile.size; //size in kb
                fileSize = fileSize / 1048576; //size in mb
            }
            //for FF, Safari, Opeara and Others
            else {
                fileSize = obj[0].files[0].size //size in kb
                fileSize = fileSize / 1048576; //size in mb
            }
            return Number(fileSize).toFixed(2);
            // return number_format();
            // alert("Uploaded File Size is" + fileSize + "MB");
        }catch (e) {
            alert("Error is :" + e);
        }
    }
</script>